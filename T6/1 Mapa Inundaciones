/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var area = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-69.80054156996496, 19.334764811971905],
          [-69.82320137309699, 19.371045043258427],
          [-69.86508768119147, 19.446818740355624],
          [-69.86440102009762, 19.490841913979494],
          [-69.89873406696502, 19.545854050148925],
          [-69.88362752679106, 19.576911450419903],
          [-69.88646611597888, 19.609465398110963],
          [-69.91393255803348, 19.647624194329218],
          [-70.00251183718825, 19.685127383592118],
          [-70.0595047001296, 19.66314380382696],
          [-70.13915736634556, 19.619167605927323],
          [-70.20782347675114, 19.64245058887906],
          [-70.31494261326475, 19.672196137103057],
          [-70.38360874822085, 19.718743341019277],
          [-70.45502154322577, 19.77561596918973],
          [-70.75625535889579, 18.34745635243585],
          [-70.71368245436169, 18.357884136470886],
          [-70.70406927140372, 18.412619461011],
          [-70.65256978544238, 18.42564916243838],
          [-70.59351698678115, 18.381344360621448],
          [-70.60381680616213, 18.29270051965727],
          [-70.5756636934865, 18.22618789634213],
          [-70.57291701931311, 18.18574621179004],
          [-70.43695840640014, 18.222274692807762],
          [-70.36142582889437, 18.22684024669341],
          [-70.30855302556783, 18.232710038865257],
          [-70.28177329419546, 18.236623118083795],
          [-70.25774019227327, 18.220318103983974],
          [-70.17190771462285, 18.219665904054114],
          [-70.12464428801464, 18.256358618044228],
          [-70.06559155698915, 18.322859718491255],
          [-70.01134543926189, 18.407578976974477],
          [-69.950919363243, 18.427123669976776],
          [-69.88156670439606, 18.459693213729704],
          [-69.76878279955137, 18.461809969960502],
          [-69.70389342280738, 18.45203981205807],
          [-69.68088872971639, 18.440151277029617],
          [-69.66509733779615, 18.407253183160233],
          [-69.64078604307794, 18.407758969598305],
          [-69.63312510883635, 18.401912205238617],
          [-69.56772028261189, 18.398653818460463],
          [-69.38472559682748, 18.416082279468068],
          [-69.239153676257, 18.42129406556311],
          [-69.14576793873708, 18.397839312605523],
          [-69.03040907489753, 18.387413884228163],
          [-68.98096952948173, 18.413475976405206],
          [-68.92400583622099, 18.624287015045674],
          [-68.86413818693407, 18.87929614679052],
          [-68.82877507884085, 18.9562701792422],
          [-68.8188184662533, 18.984192917145542],
          [-68.88130455051574, 18.998801863858134],
          [-68.94516393468261, 19.033858001966973],
          [-69.0117700188268, 19.019576856832874],
          [-69.02138328953588, 18.996854229748845],
          [-69.14841542176644, 19.059171860520202],
          [-69.21364818712986, 19.040349289759458],
          [-69.27476096218068, 19.054628756624812],
          [-69.37863399246521, 19.09911146442832],
          [-69.51665276629643, 19.097164929301332],
          [-69.62445847451536, 19.096516093285334],
          [-69.6223984872961, 19.114683534055168],
          [-69.63750501346016, 19.13739003292055],
          [-69.63269837924702, 19.171768209016612],
          [-69.62651842136948, 19.21262350701931],
          [-69.61347186556824, 19.222997837436502],
          [-69.52214600345206, 19.20743606060026],
          [-69.4315068023566, 19.197709182075908],
          [-69.32095444278423, 19.19122424300035],
          [-69.23718185434035, 19.17890221484346],
          [-69.21726867619638, 19.203545225761058],
          [-69.20353543432255, 19.238557902078778],
          [-69.17194902343782, 19.261247300218955],
          [-69.15134917131623, 19.29624766279214],
          [-69.15890242735067, 19.30985690694933],
          [-69.17881559049573, 19.307912814775406],
          [-69.24473503400117, 19.29171106776464],
          [-69.25297495280564, 19.304672637638642],
          [-69.23512175225697, 19.331888567211013],
          [-69.21658189129084, 19.357156440734187],
          [-69.2282551132376, 19.37140840258635],
          [-69.24473497679621, 19.36557822004712],
          [-69.24336166578222, 19.351973622295223],
          [-69.28387466573002, 19.332536543415994],
          [-69.31065444615714, 19.316985209987692],
          [-69.31820773031187, 19.293655415518923],
          [-69.34086754025668, 19.28458183115399],
          [-69.36902061851546, 19.302728539975583],
          [-69.40129366780975, 19.31180114909394],
          [-69.41502687646806, 19.32281719813924],
          [-69.42738677285101, 19.317633276926262],
          [-69.43974666321115, 19.323465189551484],
          [-69.47133305593425, 19.32735302615344],
          [-69.50017280888946, 19.324761167183937],
          [-69.53587916650548, 19.328648972367994],
          [-69.576392153557, 19.322169282733192],
          [-69.5853187492599, 19.305320854022135],
          [-69.62239843147906, 19.297544080318264],
          [-69.64986486020074, 19.29948831816651],
          [-69.67115134562145, 19.288470709911923],
          [-69.69449781148282, 19.28263756053213],
          [-69.72814418725962, 19.279396835412285],
          [-69.75286397079553, 19.29495176278143]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
////////////////////////////////////////////////////////////////////////////////
// Talleres de Capacitación Geoespacial de República Dominicana
// Taller: (T6) Collect Earth Online - Evaluacíon de mapas
// Organizado por: SERVIR-Amazonia, INTEC
// Autora: Andréa Puzzi Nicolau (Spatial Informatics Group)
// Titulo: Mapa inundaciones
////////////////////////////////////////////////////////////////////////////////

// Definir punto para área de interés y central el mapa.
var punto = ee.Geometry.Point([-70.2312, 18.9942]);

// Definir y diseñar un polígono de interés
Map.centerObject(area, 9);


// Definir función para escalonamiento.
function escalonamiento(imagen) {
  var bandasOpticas = imagen.select('SR_B.').multiply(0.0000275).add(-0.2);
  var bandasTermicas = imagen.select('ST_B.*').multiply(0.00341802).add(149.0);
  return imagen.addBands(bandasOpticas, null, true)
               .addBands(bandasTermicas, null, true);
}

// Definir función de enmascaramiento de nubes.
function mascaraNubes(image) {
    // Bit 0 - Llenar
    // Bit 1 - Nubes dilatadas
    // Bit 2 - Cirrus
    // Bit 3 - Nubes
    // Bit 4 - Sombra de la nubes
    var mascaraQA = image.select('QA_PIXEL').bitwiseAnd(parseInt('11111',
        2)).eq(0);
    var mascaraSat = image.select('QA_RADSAT').eq(0);

    return image.updateMask(mascaraQA)
                .updateMask(mascaraSat);
}

// Definir imágen de antes (composición mediana).
var antes = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
    .filterBounds(punto)
    .filterDate('2015-01-01', '2016-01-01')
    .filter(ee.Filter.lt('CLOUD_COVER', 20))
    .map(escalonamiento)
    .map(mascaraNubes)
    .median();

// Definir imágen de después (composición mediana).
var despues = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
    .filterBounds(punto)
    .filterDate('2022-01-01', '2023-01-01')
    .filter(ee.Filter.lt('CLOUD_COVER', 20))
    .map(escalonamiento)
    .map(mascaraNubes)
    .median();

// Calcular MNDWI.
var mndwiAntes = antes.normalizedDifference(['SR_B3', 'SR_B6'])
    .rename('mndwiAntes');
var mndwiDespues = despues.normalizedDifference(['SR_B3', 'SR_B6'])
    .rename('mndwiDespues');

// Diferencia entre imágenes.
var diferenciaM = mndwiDespues.subtract(mndwiAntes).rename('cambio');

// Definir umbrales para detección de cambios. 
var umbralGanancia = 0.7;
var umbralPerdida = -0.8;

// Crear imagen "cerada".
var difClasificadaM = ee.Image(0);

// Detección de cambios.
var difClasificadaM = difClasificadaM.where(diferenciaM.lte(umbralPerdida), 2);
var difClasificadaM = difClasificadaM.where(diferenciaM.gte(umbralGanancia), 1);

// Parámetros de visualización para los cambios.
var cambioVis = {
    palette: ['fcffc8', '2659eb', 'fa1373'],
    min: 0,
    max: 2
};

// Agregar imagen de cambios al mapa.
Map.addLayer(difClasificadaM.clip(area), cambioVis, 'Cambios clasificados por umbrales MNDWI');


